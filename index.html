<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dashboard | SING Cloud | Next-Gen AI Cloud</title>
    
    <!-- CSS and JS Libraries-->
    <script src="assets/bliss.js"></script>
    <link rel="stylesheet" href="assets/bulma.min.css">
    <script src="assets/jquery-3.7.1.min.js"></script>
    <script>jQuery.noConflict();</script>
    <script src="assets/datatables.min.js"></script>
    <link href="assets/datatables.css" rel="stylesheet">

    <!-- TACC Theme Files -->
    <link href="assets/tacc-theme.css" rel="stylesheet">
    <script src="assets/tacc-theme.js"></script>
    <script src="scripts/sing-api.js"></script>
    <script type="module" src="./scripts/sing-theme.js"></script>
    
    <!-- Font -->
    <script src="https://kit.fontawesome.com/99d5980073.js" crossorigin="anonymous"></script>
</head>
<body>
    <sing-navigation></sing-navigation>

    <section class="section launchpad">
        <div class="container">
            <div class="options">
                    <div class="option">
                        <div class="image"><i class="fa-solid fa-book"></i></div>
                        <div class="text">
                            <a href="/launch-new.html"><div class="line1">Quick Launch</div></a>
                            <div class="line2">Create a quick runtime as a notebook</div>
                        </div>
                    </div>
                <div class="option">
                    <div class="image"><i class="fa-solid fa-list-check"></i></div>
                    <div class="text">
                        <div class="line1">Launch</div>
                        <div class="line2">Choose your runtime specifications</div>
                    </div>
                </div>
                <div class="option">
                    <div class="image"><i class="fa-solid fa-database"></i></div>
                    <div class="text">
                        <a href="/storage.html"><div class="line1">Manage Storage</div></a>
                        <div class="line2">Access your cloud storage for all jobs</div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Job Card -->
    <section class="section content">
        <div class="container">
            <div id="job-cards-container">
            </div>
        </div>
        <script>
            const userHash = 'me';
            document.addEventListener('DOMContentLoaded', function() {
                function action(event, data, id, namespace, container_name){
                    return (e) => {
                        e.stopPropagation(); // so that the table row will not expand
                        
                        if (event === 'log') {
                            api.get(`/me/get-pod-log?namespace=${namespace}&pod_name=${container_name}`)
                                .then(data => {
                                    showModal(data.log);
                                })
                                .catch(error => {
                                    console.error('Error fetching log:', error);
                                });
                                
                        } else if (event === 'ssh') {
                            const sshPort = data["SSH Port"];
                        
                            if (sshPort !== 'N/A') {
                                api.post('/connect-ssh', { port: sshPort })
                                .then(data => {
                                    if (data.success) {
                                        window.location.href = `/ssh.html?session_id=${data.session_id}`;
                                    } else {
                                        alert("SSH connection failed.");
                                    }
                                })
                                .catch(error => {
                                    console.error('Error connecting to SSH:', error);
                                });
                            } else {
                                alert("SSH port is not available.");
                            }                        
                        } else if (event === 'delete') {
                            if (confirm(`Are you sure you want to delete the job ${data["Job Name"]}?`)) {
                                document.getElementById("overlay").style.display = "block";
                                api.post(`/me/delete-container`, 
                                    {
                                        namespace: namespace,
                                        container_name: container_name,
                                        job_type: data["Job Type"],
                                        job_name: data["Job Name"]
                                    }
                                )
                                .then(response => {
                                    alert("Container deleted successfully.");
                                    setTimeout(() => {
                                        location.reload();
                                    }, 2000);
                                })
                                .catch(error => {
                                    console.error('Error deleting container:', error);
                                    alert('Error deleting container.');
                                });
                            } else {
                                console.log("Deletion cancelled.");
                            }
                        } else if (event === 'edit') {
                            if (data["Status"] === 'Running') {
                                showPortMappingModal(data["Pod IP"], data["Container Name"]);
                        
                                const saveButton = document.getElementById('save-port-mapping');
                            
                                saveButton.onclick = function() {
                                    const containerPort = document.getElementById('container-port-input').value;
                                    if (containerPort) {
                                        api.get(`/port/add_proxy?ip=${data["Pod IP"]}&name=${data["Container Name"]}&port=${containerPort}`)
                                            .then(response => {
                                                const modal = document.getElementById('port-modal');
                                                modal.classList.remove('is-active');
                                                setTimeout(() => {
                                                    showPortMappingModal(data["Pod IP"], data["Container Name"]);
                                                }, 2);
                                                if (typeof response === 'string') {
                                                    alert(response);
                                                } else if (response.port) {
                                                    alert(`Successfully mapped container port ${containerPort} to external port ${response.port}`);
                                                } else {
                                                    alert('Failed to map port.');
                                                }
                                            })
                                            .catch(error => {
                                                if (error.message && error.message.includes('not valid JSON')) {
                                                    alert(`Successfully mapped container port ${containerPort}`);
                                                    const modal = document.getElementById('port-modal');
                                                    modal.classList.remove('is-active');
                                                    setTimeout(() => {
                                                        showPortMappingModal(data["Pod IP"], data["Container Name"]);
                                                    }, 2);
                                                } else {
                                                    console.error('Error mapping port:', error);
                                                    alert('Failed to map port.');
                                                }
                                            });
                                    }
                                };
                            } else {
                                alert('Cannot edit. The container is not running.');
                            }
                            
                        } else {
                            alert(`Trigger ${event} ${id}`);
                        }
                    };
                }                

                function row_render(data, table){
                    var header = ["Container ID", "Container Name", "GPU", "Actions"];
                    var result = []
                    var display = $.create("tr", {
                        contents: header.map((key) =>
                            ({
                                tag:"td", contents: (()=>{
                                    switch (key) {
                                        case "Container ID":
                                            const statusClass = getStatusClass(data["Status"]);
                                            return $.create("div", {
                                                contents: [
                                                    {tag: "div", contents: [
                                                        {tag: "span", className: `status-badge ${statusClass}`, contents: data["Status"]},
                                                        {tag: "span", contents: ` ${data["Container ID"]}`}
                                                    ]},
                                                    {tag: "div", contents: `${data["Pod IP"]}`}
                                                ]
                                            });
                                        case "Container Name":
                                            return data["Container Name"];
                                        case "GPU":
                                            return $.create("div", {
                                                contents: [
                                                    {tag: "span", contents: data["GPU Request"] !== 'N/A' ? `RTX3090 ` : 'N/A'},
                                                    {tag: "span", className: "info-icon", contents: "i", 
                                                    attributes: {
                                                        "data-info": `GPU Request: ${data["GPU Request"]}, GPU Limit: ${data["GPU Limit"]}, CPU Request: ${data["CPU Request"]}, Memory Request: ${data["Memory Request"]}`}
                                                    }
                                                ]
                                            });
                                        case "Actions":
                                            return $.create("div", {
                                                className: "actions",
                                                contents: [
                                                    {   tag: "div",
                                                        className: "action-item",
                                                        events: {
                                                            click: action("edit", data, data["Container ID"], data["Namespace"], data["Container Name"])
                                                        },
                                                        contents: [
                                                            {tag:"i", className: "fa-regular fa-pen-to-square"},
                                                            {tag:"span", contents: "Port Mapping"}
                                                        ]
                                                    },
                                                    {   tag: "div", 
                                                        className: "action-item",
                                                        events: {
                                                            click: action("log", data, data["Container ID"], data["Namespace"], data["Container Name"])
                                                        },
                                                        contents: [
                                                            {tag:"i", className: "fa-solid fa-file-alt"},
                                                            {tag:"span", contents: "Output"}
                                                        ]
                                                    },
                                                    {   tag: "div", 
                                                        className: "action-item",
                                                        events: {
                                                            click: (e) => {
                                                                e.stopPropagation();
                                                                showSshCommandModal(data["Pod IP"], data["SSH Port"]);
                                                            }
                                                        },
                                                        contents: [
                                                            {tag:"i", className: "fa-solid fa-terminal"},
                                                            {tag:"span", contents: "SSH"}
                                                        ]
                                                    },
                                                    {   tag: "div", 
                                                        className: "action-item",
                                                        events: {
                                                            click: action("ssh", data, data["Container ID"], data["Namespace"], data["Container Name"])
                                                        },
                                                        contents: [
                                                            {tag:"i", className: "fa-solid fa-terminal"},
                                                            {tag:"span", contents: "Terminal"}
                                                        ]
                                                    }
                                                ]
                                            });
                                        default:
                                            return data[key];
                                    }
                                })(),
                            })
                        )
                    });
                    result.push(display);
                    return result;
                }
                

                function header_render(){
                    var header = ["Container ID", "Container Name", "GPU", "Actions"];
                    return $.create("thead", { contents: {
                        tag: "tr",
                        contents: header.map((key) =>
                            ({tag:"th", contents: key})
                        )
                    }});
                }

                // Reorganize by jobs
                function groupContainersByJob(containers) {
                    const jobMap = new Map();
                    
                    containers.forEach(container => {
                        let jobName = container["Job Name"];
                        if (!jobName || jobName === 'N/A' || jobName.trim() === '') {
                            jobName = `Job-${container["Container Name"]}`;
                        }
                        if (!jobMap.has(jobName)) {
                            jobMap.set(jobName, []);
                        }
                        jobMap.get(jobName).push(container);
                    });
                    
                    return jobMap;
                }
                
                // Job card
                function createJobCard(jobName, containers) {
                    const firstContainer = containers[0];
                    const statusClass = getStatusClass(firstContainer["Status"]);
                    const jobId = `job-${jobName.replace(/\s+/g, '-').toLowerCase()}`;
                    const tableId = `table-${jobId}`;
                    
                    let totalGPU = 0;
                    containers.forEach(container => {
                        const gpuRequest = container["GPU Request"];
                        if (gpuRequest && gpuRequest !== 'N/A') {
                            const gpuValue = parseFloat(gpuRequest);
                            if (!isNaN(gpuValue)) {
                                totalGPU += gpuValue;
                            }
                        }
                    });
                    
                    const card = document.createElement('div');
                    card.className = 'box job-card';
                    card.setAttribute('data-job-name', jobName);
                    card.innerHTML = `
                        <div class="job-card-header" onclick="toggleJobContainers('${jobId}')">
                            <div class="job-header-top">
                                <div class="job-title">
                                    <span class="status-badge ${statusClass}">${firstContainer["Status"]}</span>
                                    ${jobName}
                                </div>
                                <div class="job-actions">
                                    <div class="job-action-button info" onclick="event.stopPropagation(); showSetupInfo('${jobName}')">
                                        <i class="fa-solid fa-info-circle"></i>
                                        <span>Info</span>
                                    </div>
                                    <div class="job-action-button copy" onclick="event.stopPropagation(); cloneJob('${jobName}')">
                                        <i class="fa-regular fa-clone"></i>
                                        <span>Clone</span>
                                    </div>
                                    <div class="job-action-button stop" onclick="event.stopPropagation(); stopJob('${jobName}', '${firstContainer["Namespace"]}', ${JSON.stringify(containers)})">
                                        <i class="fa-solid fa-stop"></i>
                                        <span>Stop</span>
                                    </div>
                                    <div class="job-action-button danger" onclick="event.stopPropagation(); deleteJob('${jobName}', '${firstContainer["Namespace"]}', ${JSON.stringify(containers)})">
                                        <i class="fa-regular fa-trash-alt"></i>
                                        <span>Delete</span>
                                    </div>
                                </div>
                            </div>
                            <div class="job-meta">
                                <div class="job-meta-item">
                                    <i class="fa-solid fa-user job-meta-icon"></i>
                                    <div class="job-meta-value">${firstContainer["Namespace"]}</div>
                                </div>
                                <div class="job-meta-item">
                                    <i class="fa-solid fa-clock job-meta-icon"></i>
                                    <div class="job-meta-value">${firstContainer["Creation Time"]}</div>
                                </div>
                                <div class="job-meta-item">
                                    <i class="fa-solid fa-microchip job-meta-icon"></i>
                                    <div class="job-meta-value">${totalGPU || "0"} GPU</div>
                                </div>
                                <div class="job-meta-item">
                                    <i class="fa-solid fa-database job-meta-icon"></i>
                                    <div class="job-meta-value job-image" title="${firstContainer["Image"]}">${formatImageName(firstContainer["Image"])}</div>
                                </div>
                            </div>
                        </div>
                        <div id="${jobId}" class="job-containers" style="display: none;">
                            <div class="table-container">
                                <table id="${tableId}" class="table is-fullwidth container-table">
                                    <thead>
                                        <tr>
                                            <th>Container ID</th>
                                            <th>Container Name</th>
                                            <th>GPU</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${containers.map(container => {
                                            const containerStatusClass = getStatusClass(container["Status"]);
                                            return `
                                                <tr>
                                                    <td>
                                                        <div>
                                                            <div>
                                                                <span class="status-badge ${containerStatusClass}">${container["Status"]}</span>
                                                                <span>${container["Container ID"]}</span>
                                                            </div>
                                                            <div>${container["Pod IP"]}</div>
                                                        </div>
                                                    </td>
                                                    <td>${container["Container Name"]}</td>
                                                    <td>
                                                        <div>
                                                            <span>${container["GPU Request"] !== 'N/A' ? `RTX3090 ` : 'N/A'}</span>
                                                            <span class="info-icon" data-info="GPU Request: ${container["GPU Request"]}, GPU Limit: ${container["GPU Limit"]}, CPU Request: ${container["CPU Request"]}, Memory Request: ${container["Memory Request"]}">i</span>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="actions">
                                                            <div class="action-item" onclick="editContainer('${container["Pod IP"]}', '${container["Container Name"]}', '${container["Status"]}')">
                                                                <i class="fa-regular fa-pen-to-square"></i>
                                                                <span>Port</span>
                                                            </div>
                                                            <div class="action-item" onclick="showContainerLog('${container["Namespace"]}', '${container["Container Name"]}')">
                                                                <i class="fa-solid fa-file-alt"></i>
                                                                <span>Output</span>
                                                            </div>
                                                            <div class="action-item" onclick="showSshCommand('${container["Pod IP"]}', '${container["SSH Port"]}')">
                                                                <i class="fa-solid fa-link"></i>
                                                                <span>SSH</span>
                                                            </div>
                                                            <div class="action-item" onclick="connectSsh('${container["SSH Port"]}')">
                                                                <i class="fa-solid fa-terminal"></i>
                                                                <span>Terminal</span>
                                                            </div>
                                                        </div>
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                    
                    return card;
                }

                // Container table
                function fetchPodInfo() {
                    api.get(`/me/pods`)
                        .then(response => {
                            var row_data = []
                            Object.keys(response).forEach(function(namespace) {
                                row_data.push(...response[namespace])
                            });
                            
                            const jobsMap = groupContainersByJob(row_data);
                            const jobCardsContainer = document.getElementById('job-cards-container');
                            jobCardsContainer.innerHTML = '';
                            
                            let index = 0;
                            jobsMap.forEach((containers, jobName) => {
                                if (jobName !== 'N/A') {
                                    const jobCard = createJobCard(jobName, containers);
                                    jobCardsContainer.appendChild(jobCard);
                                    index++;
                                }
                            });
                            
                            // datatables for containers
                            setTimeout(() => {
                                document.querySelectorAll('.container-table').forEach(table => {
                                    jQuery(table).DataTable({
                                        paging: true,
                                        searching: true,
                                        ordering: true,
                                        info: true,
                                        pageLength: 5,
                                        lengthMenu: [5, 10, 25, 50],
                                        language: {
                                            search: "",
                                            searchPlaceholder: "Search containers..."
                                        }
                                    });
                                });
                            }, 100);
                        })
                        .catch(error => {
                            console.log(error);
                        });
                }
                
                // Toggle container tables
                window.toggleJobContainers = function(jobId) {
                    const containersDiv = document.getElementById(jobId);
                    if (containersDiv) {
                        const isVisible = containersDiv.style.display !== 'none';
                        containersDiv.style.display = isVisible ? 'none' : 'block';
                        
                        const jobCardHeader = containersDiv.previousElementSibling;
                        const expandIcon = jobCardHeader.querySelector('.expand-icon i');
                        if (expandIcon) {
                            expandIcon.className = isVisible ? 'fa-solid fa-chevron-down' : 'fa-solid fa-chevron-up';
                        }
                        
                        if (!isVisible) {
                            const tableId = `table-${jobId}`;
                            const table = jQuery(`#${tableId}`).DataTable();
                            if (table) {
                                table.columns.adjust().draw();
                            }
                        }
                    }
                };
                
                // Container actions
                // edit port mapping
                window.editContainer = function(podIp, containerName, status) {
                    if (status === 'Running') {
                        showPortMappingModal(podIp, containerName);
                    } else {
                        alert('Cannot edit. The container is not running.');
                    }
                };
                
                // show container log
                window.showContainerLog = function(namespace, containerName) {
                    api.get(`/me/get-pod-log?namespace=${namespace}&pod_name=${containerName}`)
                        .then(data => {
                            showModal(data.log);
                        })
                        .catch(error => {
                            console.error('Error fetching log:', error);
                        });
                };
                
                // show ssh command
                window.showSshCommand = function(podIp, sshPort) {
                    showSshCommandModal(podIp, sshPort);
                };
                
                // connect in web
                window.connectSsh = function(sshPort) {
                    if (sshPort !== 'N/A') {
                        api.post('/connect-ssh', { port: sshPort })
                        .then(data => {
                            if (data.success) {
                                window.location.href = `/ssh.html?session_id=${data.session_id}`;
                            } else {
                                alert("SSH connection failed.");
                            }
                        })
                        .catch(error => {
                            console.error('Error connecting to SSH:', error);
                        });
                    } else {
                        alert("SSH port is not available.");
                    }
                };
                
                // Job card actions
                // setup info
                window.showSetupInfo = function(jobName) {
                    alert(`Setup information for ${jobName}`);
                };
                
                // stop action
                window.stopJob = function(jobName, namespace, containers) {
                    if (confirm(`Are you sure you want to stop the job ${jobName}?`)) {
                        document.getElementById("overlay").style.display = "block";
                        
                        // attention: here the stop-container API not implemented yet
                        const stopPromises = containers.map(container => {
                            return api.post(`/me/stop-container`, {
                                namespace: container["Namespace"],
                                container_name: container["Container Name"]
                            });
                        });
                        
                        Promise.all(stopPromises)
                            .then(responses => {
                                alert(`Job ${jobName} stopped successfully.`);
                                setTimeout(() => {
                                    location.reload();
                                }, 2000);
                            })
                            .catch(error => {
                                console.error('Error stopping job:', error);
                                alert('Error stopping job.');
                                document.getElementById("overlay").style.display = "none";
                            });
                    }
                };
                
                // clone action
                window.cloneJob = function(jobName) {
                    alert(`Cloning job ${jobName}`);
                    // attention: not implemented yet, will update after the create-job API is ready
                };
                
                // delete action
                window.deleteJob = function(jobName, namespace, containers) {
                    if (confirm(`Are you sure you want to delete the job ${jobName}?`)) {
                        document.getElementById("overlay").style.display = "block";
                        
                        // delete all containers in the job
                        const deletePromises = containers.map(container => {
                            return api.post(`/me/delete-container`, {
                                namespace: container["Namespace"],
                                container_name: container["Container Name"],
                                job_type: container["Job Type"],
                                job_name: jobName
                            });
                        });
                        
                        Promise.all(deletePromises)
                            .then(responses => {
                                alert(`Job ${jobName} deleted successfully.`);
                                setTimeout(() => {
                                    location.reload();
                                }, 2000);
                            })
                            .catch(error => {
                                console.error('Error deleting job:', error);
                                alert('Error deleting job.');
                                document.getElementById("overlay").style.display = "none";
                            });
                    }
                };

                // Function to show modal
                function showModal(logContent) {
                    const modal = document.getElementById('log-modal');
                    const logContentElement = document.getElementById('log-content');
                    logContentElement.textContent = logContent;
                    modal.classList.add('is-active');
                }

                // Function to close modal
                function closeModal() {
                    const modal = document.getElementById('log-modal');
                    modal.classList.remove('is-active');
                }

                function showPortMappingModal(podIp, containerName) {
                    const modal = document.getElementById('port-modal');
                    const existingMappings = document.getElementById('existing-port-mappings');
                    const modalClose = modal.querySelector('.modal-close');
                    const modalBackground = modal.querySelector('.modal-background');

                    // Clear previous input
                    document.getElementById('container-port-input').value = '';

                    function portMappingHeaderRender() {
                        var header = ["Container Port", "Allocated Port", "Action"];
                        return $.create("thead", { contents: {
                            tag: "tr",
                            contents: header.map((key) =>
                                ({
                                    tag: "th",
                                    contents: key,
                                    style: {
                                        textAlign: 'center'
                                    }
                                })
                            )
                        }});
                    }

                    function portMappingRowRender(mappings) {
                        var header = ["Container Port", "Allocated Port", "Action"];
                        var result = [];
                        mappings.forEach(mapping => {
                            var display = $.create("tr", {
                                contents: header.map((key) =>
                                    ({
                                        tag: "td",
                                        contents: (() => {
                                            switch (key) {
                                                case "Action":
                                                    return $.create("div", {
                                                        className: "actions",
                                                        contents: [
                                                            {
                                                                tag: "div",
                                                                events: {
                                                                    click: (e) => {
                                                                        e.stopPropagation();
                                                                        if (confirm(`Are you sure you want to delete port mapping ${mapping.container_port}?`)) {
                                                                            api.get(`/port/remove_proxy?ip=${podIp}&name=${containerName}&port=${mapping.container_port}`, null, true)
                                                                                .then(response => {
                                                                                    alert(`Successfully removed port mapping: ${mapping.container_port}`);                                                                                
                                                                                    const modal = document.getElementById('port-modal');
                                                                                    modal.classList.remove('is-active');
                                                                                    setTimeout(() => {
                                                                                        showPortMappingModal(podIp, containerName);
                                                                                    }, 2);
                                                                                })
                                                                                .catch(error => {
                                                                                    if (error.message && error.message.includes('not valid JSON')) {
                                                                                        alert(`Successfully removed port mapping: ${mapping.container_port}`);
                                                                                        const modal = document.getElementById('port-modal');
                                                                                        modal.classList.remove('is-active');
                                                                                        setTimeout(() => {
                                                                                            showPortMappingModal(podIp, containerName);
                                                                                        }, 2);
                                                                                    } else {
                                                                                        console.error('Error removing port mapping:', error);
                                                                                        alert('Failed to remove port mapping.');
                                                                                    }
                                                                                });
                                                                        }
                                                                    }
                                                                },
                                                                contents: {
                                                                    tag: "i",
                                                                    className: "fa-solid fa-trash-alt"
                                                                }
                                                            }
                                                        ]
                                                    });
                                                case "Container Port":
                                                    return mapping.container_port;
                                                case "Allocated Port":
                                                    return mapping.allocated_port;
                                            }
                                        })()
                                    })
                                )
                            });
                            result.push(display);
                        });
                        return result;
                    }

                    // Fetch existing port mappings
                    api.get(`/port/get_port?ip=${podIp}`)
                        .then(data => {
                            existingMappings.innerHTML = '';
                            
                            // Create title
                            const titleDiv = document.createElement('div');
                            titleDiv.className = 'content';
                            titleDiv.innerHTML = '<h4 class="title is-6">Existing Mappings</h4>';
                            existingMappings.appendChild(titleDiv);

                            if (data.ports && data.ports.length > 0) {
                                const tableContainer = document.createElement('div');
                                tableContainer.className = 'table-container';
                                existingMappings.appendChild(tableContainer);

                                const table = document.createElement('table');
                                table.className = 'table is-fullwidth is-striped';
                                tableContainer.appendChild(table);

                                // Add header
                                table.appendChild(portMappingHeaderRender());

                                // Add body
                                const tbody = document.createElement('tbody');
                                portMappingRowRender(data.ports).forEach(row => {
                                    tbody.appendChild(row);
                                });
                                table.appendChild(tbody);
                            } else {
                                const noDataDiv = document.createElement('p');
                                noDataDiv.textContent = 'No existing port mappings';
                                existingMappings.appendChild(noDataDiv);
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching port mappings:', error);
                            existingMappings.textContent = 'Error fetching port mappings.';
                        });
                
                    modal.classList.add('is-active');

                    // Add close handlers
                    modalClose.onclick = hideModal;
                    modalBackground.onclick = hideModal;
                }
                
                function hideModal() {
                    const modal = document.getElementById('port-modal');
                    modal.classList.remove('is-active');
                }

                // Add event listeners for modal close
                document.querySelector('.modal-close').addEventListener('click', closeModal);
                document.querySelector('.modal-background').addEventListener('click', closeModal);
                // Fetch and render the table on page load
                fetchPodInfo();

                // show SSH command modal
                function showSshCommandModal(podIp, sshPort) {
                    let modal = document.getElementById('ssh-command-modal');
                    if (!modal) {
                        modal = document.createElement('div');
                        modal.id = 'ssh-command-modal';
                        modal.className = 'modal';
                        modal.innerHTML = `
                            <div class="modal-background"></div>
                            <div class="modal-content">
                                <div class="box">
                                    <h3 class="title is-5">SSH Command</h3>
                                    <div class="field">
                                        <label class="label">Use this command to connect via SSH:</label>
                                        <div class="control">
                                            <input id="ssh-command" class="input" type="text" readonly>
                                        </div>
                                    </div>
                                    <button class="button is-primary copy-button">Copy to Clipboard</button>
                                </div>
                            </div>
                            <button class="modal-close is-large" aria-label="close"></button>
                        `;
                        document.body.appendChild(modal);
                        
                        // Add event listeners
                        modal.querySelector('.modal-close').addEventListener('click', () => {
                            modal.classList.remove('is-active');
                        });
                        modal.querySelector('.modal-background').addEventListener('click', () => {
                            modal.classList.remove('is-active');
                        });
                        modal.querySelector('.copy-button').addEventListener('click', () => {
                            const commandInput = document.getElementById('ssh-command');
                            commandInput.select();
                            document.execCommand('copy');
                            alert('Command copied to clipboard!');
                        });
                    }
                    
                    // Set SSH command
                    const sshCommand = `ssh root@${podIp} -p ${sshPort}`;
                    document.getElementById('ssh-command').value = sshCommand;
                    
                    // Show the modal
                    modal.classList.add('is-active');
                }

                // job/container status class
                function getStatusClass(status) {
                    status = status.toLowerCase();
                    if (status === 'running') return 'status-running';
                    if (status === 'pending' || status === 'containercreating' || status === 'podinitialized') return 'status-pending';
                    if (status === 'failed' || status === 'error' || status === 'crashloopbackoff') return 'status-failed';
                    if (status === 'completed' || status === 'succeeded') return 'status-completed';
                    return 'status-unknown';
                }

                // tooltip
                const tooltip = document.createElement('div');
                tooltip.className = 'gpu-tooltip';
                document.body.appendChild(tooltip);

                // show tooltip when over the icon
                document.addEventListener('mouseover', function(e) {
                    if (e.target.classList.contains('info-icon')) {
                        const infoText = e.target.getAttribute('data-info');
                        tooltip.textContent = infoText;
                        tooltip.classList.add('visible');
                        
                        // calculate position
                        const rect = e.target.getBoundingClientRect();
                        const tooltipHeight = tooltip.offsetHeight;
                        const tooltipWidth = tooltip.offsetWidth;
                        
                        let top = rect.top - tooltipHeight - 10;
                        let left = rect.left - (tooltipWidth / 2) + (rect.width / 2);
                        if (top < 10) {
                            top = rect.bottom + 10;
                        }
                        
                        if (left < 10) left = 10;
                        if (left + tooltipWidth > window.innerWidth - 10) {
                            left = window.innerWidth - tooltipWidth - 10;
                        }
                        
                        tooltip.style.top = `${top}px`;
                        tooltip.style.left = `${left}px`;
                    }
                });

                document.addEventListener('mouseout', function(e) {
                    if (e.target.classList.contains('info-icon')) {
                        tooltip.classList.remove('visible');
                    }
                });

                function formatImageName(imagePath) {
                    if (!imagePath) return 'N/A';
                    const parts = imagePath.split('/');
                    if (parts.length >= 2) {
                        return parts[parts.length - 1];
                    }
                    return imagePath;
                }
            });
        </script>
    </section>

    <footer class="section footer">
        <div class="container">
            <div class="columns content">
                <div class="column items is-3">
                    <div class="item item-title">TACC Workflow</div>
                    <div class="item">Launch & Monitor AI Jobs</div>
                    <div class="item">Access Cloud Storage</div>
                    <div class="item">Manage Code & Scripts</div>
                </div>
                <div class="column items is-3">
                    <div class="item item-title">TACC Space</div>
                    <div class="item">Latest Public Images</div>
                    <div class="item">Public Dataset</div>
                    <div class="item">Discussion Groups</div>
                </div>
                <div class="column items is-3">
                    <div class="item item-title">Research</div>
                    <div class="item">AI-centric Networking</div>
                    <div class="item">Machine Learning Systems</div>
                    <div class="item">Cluster Resource Scheduling</div>
                </div>
                <div class="column items is-3">
                    <div class="item item-title">Company</div>
                    <div class="item">Our Team</div>
                    <div class="item">Careers</div>
                    <div class="item">HKUST iSING Lab</div>
                </div>
            </div>
            <div class="columns is-align-items-center">
                <div class="column is-narrow logo"><img src="assets/tacc-logo.png" /></div>
                <div class="column copyright is-narrow"><span class="text-brand"></span>  20202024</div>
            </div>
        </div>
    </footer>

    <div id="log-modal" class="modal">
        <div class="modal-background"></div>
        <div class="modal-content">
            <div class="box">
                <pre id="log-content"></pre>
            </div>
        </div>
        <button class="modal-close is-large" aria-label="close"></button>
    </div>

    <div id="overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0, 0, 0, 0.5); z-index:1000; text-align:center; color:white; font-size:24px;">
        <div style="position:relative; top:50%; transform:translateY(-50%);">
            Please wait...
        </div>
    </div>

    <div id="port-modal" class="modal">
        <div class="modal-background"></div>
        <div class="modal-content">
            <div class="box">
                <h3 class="title is-5">Port Mapping</h3>
                <div id="existing-port-mappings" class="mb-4"></div>
                <div class="field">
                    <label class="label">Add New Port Mapping</label>
                    <div class="control">
                        <input id="container-port-input" class="input" type="number" placeholder="Enter container port (e.g.8080)">
                    </div>
                    <p class="help">Specify the port number that your application uses inside the container</p>
                </div>
                <div class="field is-grouped">
                    <div class="control">
                        <button id="save-port-mapping" class="button is-link">Map Port</button>
                    </div>
                </div>
            </div>
        </div>
        <button class="modal-close is-large" aria-label="close"></button>
    </div>
    
    
    
    

</body>
</html>